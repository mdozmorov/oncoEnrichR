### CRISPR/Cas9 loss-of-fitness {.tabset}

* In [Project Score](https://score.depmap.sanger.ac.uk/), systematic genome-scale CRISPR/Cas9 drop-out screens are performed in a large number of highly-annotated cancer models to identify genes required for cell fitness in defined molecular contexts
* Here, we are showing, across the main human tissue types:
   * Genes in the target set that are annotated with a [statistically significant effect on cell fitness](https://score.depmap.sanger.ac.uk/documentation) in any of the screened cancer cell lines (__fitness score__ is here considered a quantitative measure of the reduction of cell viability elicited by a gene inactivation, via CRISPR/Cas9 targeting). The fitness score is computed based on the [BAGEL](https://github.com/francescojm/BAGELR) and [CRISPRCleanR](https://github.com/francescojm/CRISPRcleanR) algorithms. 

<br><br>


```{r filter_crispr, echo=F, results='asis'}

show_crispr_data <- T
missing_crispr_data <- F
if(nrow(onc_enrich_report[['data']][['loss_of_fitness']][['hits_df']]) == 0){
    show_crispr_data <- F
    missing_crispr_data <- T
}

```



#### Loss-of-fitness distribution

```{r lof_crispr_plot, echo = F, results = "asis", eval = nrow(onc_enrich_report[['data']][['loss_of_fitness']][['hits_df']]) > 0, fig.width = 11, fig.height = onc_enrich_report[['config']][['loss_of_fitness']][['plot_height']]}

  p <- onc_enrich_report[['data']][['loss_of_fitness']][['hits_df']] %>%
      dplyr::mutate(symbol = forcats::fct_reorder(symbol, n_gene)) %>%
      ggplot2::ggplot(ggplot2::aes(x = symbol, y = n_gene_tissue, fill = tissue)) +
      ggplot2::geom_bar(stat = "identity") +
      ggplot2::coord_flip() +
      ggplot2::ylab("Number of cell lines with loss-of-fitness in CRISPR/Cas9 drop-out screen") +
      ggplot2::xlab("") +
      ggplot2::scale_fill_manual(values = pals::stepped(15)) +
      ggplot2::theme(
        panel.grid.minor = ggplot2::element_blank(),
        axis.text = ggplot2::element_text(family = "Helvetica", size = 11),
        legend.text = ggplot2::element_text(family = "Helvetica", size = 11),
        axis.title.x = ggplot2::element_text(family = "Helvetica", size = 12),
        legend.title = ggplot2::element_blank(),
        #set thickness of axis ticks
        axis.ticks = ggplot2::element_line(size = 0.2),
        #remove plot background
        plot.background = ggplot2::element_blank()
      )

plotly::ggplotly(p)
#plotly::ggplotly(onc_enrich_report[['data']][['loss_of_fitness']][['plot']])

```


```{r crispr_missing_plot, echo=F, results = 'asis', eval = missing_crispr_data}
cat('<i>No genes in target set found with loss-of-fitness effect from CRISPR/Cas9 screens in Project Score</i>',sep='\n')
cat('\n')
```

<br><br><br>

#### Loss-of-fitness table

```{r lof_crispr_table, echo=F, results = "asis", eval = show_crispr_data}

htmltools::br()

lof_df <- onc_enrich_report[['data']][['loss_of_fitness']][['hits_df']] %>%
  dplyr::select(symbol_link_ps, tissue, cmp_link) %>%
  dplyr::rename(cell_lines = cmp_link, symbol = symbol_link_ps) %>%
  dplyr::mutate(loss_of_fitness = T)

lof_table <- 
  crosstalk::SharedData$new(lof_df)

crosstalk::bscols(
  list(
    crosstalk::filter_select("tissue", "Tissue", 
                             lof_table, ~tissue)
  )
)

DT::datatable(
  lof_table, 
  escape = F, 
  extensions = c("Buttons","Responsive"), 
  width = "100%",
  options = list(buttons = c('csv','excel'),
               dom = 'Bfrtip', 
               pagelength = 20)
  )



```

```{r crispr_missing_data, echo=F, results = 'asis', eval = missing_crispr_data}

cat('<i>No genes in target set found with loss-of-fitness effect from CRISPR/Cas9 screens in Project Score</i>', sep='\n')
cat('\n')

```

<br><br><br>
